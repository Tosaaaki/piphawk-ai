# エントリーフィルタ概要

このシステムには複数の指標を組み合わせたエントリーフィルタが実装されています。2025 年版では特に以下のポイントが追加されました。

- **マルチタイムフレーム整合性**: M1/M5/H1 の EMA 方向がそろわない場合はエントリーを見送り。
- **急反転フィルタ**: EMA の収束と同時に傾きが反転、または一定幅以内でフラットになった場合はトレンドが失速したと判断しブロック。
- **ボリュームチェック**: 直近の出来高平均が `MIN_VOL_MA` (`MIN_VOL_M1`) を下回るときはエントリーしない。

関連する主な環境変数は次の通りです。

- `VOL_MA_PERIOD`: 出来高平均を計算する期間。
- `MIN_VOL_MA` / `MIN_VOL_M1`: ボリュームフィルタの最小許容値。
- `EMA_FLAT_PIPS`: EMA の傾きがフラットとみなされる許容幅。
- `ADX_SLOPE_LOOKBACK`: ADX の傾きを計算する際の参照本数。
- `ADX_DYNAMIC_COEFF`: ボリンジャーバンド幅に応じて ADX しきい値を補正する係数。
- `TF_EMA_WEIGHTS`: 上位足EMA整合の重み付け (`M5:0.4,H1:0.3,H4:0.3` など)。
- `OVERSHOOT_ATR_MULT`: 価格が BB 下限を ATR×この値だけ下回るとエントリーを阻止。
- `STRICT_TF_ALIGN`: マルチTF整合が得られない場合でもエントリーするかどうか。
- `REV_BLOCK_BARS`: 急反転を検知するために参照するローソク足本数。
- `TAIL_RATIO_BLOCK`: ヒゲと実体の比率がこの値以上ならエントリーをブロック。
- `VOL_SPIKE_PERIOD`: ボリュームスパイク判定に用いる平均期間。
- `BLOCK_COUNTER_TREND`: M15/H1 が同方向でポジションと逆ならエントリーを停止。
- `COUNTER_BYPASS_ADX`: M5 ADX がこの値以上でポジションと同方向なら逆張り判定を無視。

## 急反転フィルタの例

```
EMA_fast : [1.1000, 1.1020, 1.1010]
EMA_slow : [1.0990, 1.1005, 1.1008]
```

上記のように EMA 差が縮小しつつ最新の傾きが逆方向へ転じた場合、急反転フィルタが働きエントリーはスキップされます。
